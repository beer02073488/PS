<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard ระบบจัดการยอดขาย</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');

    body {
      font-family: 'Kanit', sans-serif;
    }

    .report-page {
      display: none;
    }

    .report-page.active {
      display: block;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .data-table th {
      background-color: #f7fafc;
      font-weight: 600;
    }

    .edit-mode {
      border: 2px solid #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }
  </style>
</head>

<body class="bg-gray-50">
  <div class="container mx-auto px-4 py-6">
    <!-- Navbar -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex justify-between items-center mb-6">
        <div class="flex space-x-4">
          <button class="px-4 py-2 bg-blue-600 text-white rounded-md flex items-center transition hover:bg-blue-700">
                        <i class="fab fa-facebook mr-2"></i> Facebook
                    </button>
          <button class="px-4 py-2 bg-black text-white rounded-md flex items-center transition hover:bg-gray-800">
                        <i class="fab fa-tiktok mr-2"></i> TikTok
                    </button>
          <button class="px-4 py-2 bg-orange-500 text-white rounded-md flex items-center transition hover:bg-orange-600">
                        <i class="fas fa-shopping-bag mr-2"></i> Shopee
                    </button>
        </div>
        <div class="flex items-center space-x-3">
          <span class="text-sm text-gray-500">Version 1.0</span>
          <button class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 transition">Reset</button>
          <button class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 transition">Show code</button>
          <button class="text-sm bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700 transition">Use in a design</button>
        </div>
      </div>

      <!-- เมนูหลัก -->
      <div class="flex space-x-2">
        <button id="dashboard-btn" onclick="showPage('dashboard')" class="menu-button px-4 py-2 rounded-md flex items-center bg-purple-600 text-white transition hover:bg-purple-700">
                    <i class="fas fa-home mr-2"></i> หน้าหลัก
                </button>
        <button id="facebook-report-btn" onclick="showPage('facebook-report')" class="menu-button px-4 py-2 bg-gray-200 rounded-md flex items-center transition hover:bg-gray-300">
                    <i class="fab fa-facebook mr-2 text-blue-600"></i> รายงาน Facebook
                </button>
        <button id="tiktok-report-btn" onclick="showPage('tiktok-report')" class="menu-button px-4 py-2 bg-gray-200 rounded-md flex items-center transition hover:bg-gray-300">
                    <i class="fab fa-tiktok mr-2 text-black"></i> รายงาน TikTok
                </button>
        <button id="shopee-report-btn" onclick="showPage('shopee-report')" class="menu-button px-4 py-2 bg-gray-200 rounded-md flex items-center transition hover:bg-gray-300">
                    <i class="fas fa-shopping-bag mr-2 text-orange-500"></i> รายงาน Shopee
                </button>
      </div>
    </div>

    <!-- Cards สถิติ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow-md p-6 flex items-center transition hover:shadow-lg">
        <div class="mr-4">
          <div class="text-green-600 text-2xl font-bold" id="totalSales">฿0</div>
          <div class="text-gray-500 text-sm">ยอดชำระทั้งหมด</div>
        </div>
        <div class="text-green-600 text-2xl">
          <i class="fas fa-exchange-alt"></i>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 flex items-center transition hover:shadow-lg">
        <div class="mr-4">
          <div class="text-red-600 text-2xl font-bold" id="totalInstall">฿0</div>
          <div class="text-gray-500 text-sm">ค่าติดตั้งทั้งหมด</div>
        </div>
        <div class="text-red-600 text-2xl">
          <i class="fas fa-ad"></i>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 flex items-center transition hover:shadow-lg">
        <div class="mr-4">
          <div class="text-yellow-600 text-2xl font-bold" id="totalAmount">฿0</div>
          <div class="text-gray-500 text-sm">จำนวนทั้งหมด</div>
        </div>
        <div class="text-yellow-600 text-2xl">
          <i class="fas fa-chart-bar"></i>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-md p-6 flex items-center transition hover:shadow-lg">
        <div class="mr-4">
          <div class="text-purple-600 text-2xl font-bold" id="totalCost">฿0</div>
          <div class="text-gray-500 text-sm">ค่าใช้จ่ายทั้งหมด</div>
        </div>
        <div class="text-purple-600 text-2xl">
          <i class="fas fa-coins"></i>
        </div>
      </div>
    </div>

    <!-- หน้าหลัก (Dashboard) -->
    <div id="dashboard" class="report-page active">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- ฟอร์มเพิ่ม/แก้ไขข้อมูล -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold" id="form-title">+ เพิ่มข้อมูลยอดชำระ</h2>
          </div>
          <form id="sales-form" onsubmit="event.preventDefault(); saveForm();">
            <input type="hidden" id="edit-row-index" value="-1">

            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-medium mb-2">แพลตฟอร์ม</label>
              <select id="platform" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                                <option value="Facebook">Facebook</option>
                                <option value="TikTok">TikTok</option>
                                <option value="Shopee">Shopee</option>
                            </select>
            </div>

            <div class="mb-4">
              <label class="block text-gray-700 text-sm font-medium mb-2">ชื่อลินก์</label>
              <input type="text" id="link-name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">จำนวน</label>
                <input type="number" id="quantity" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" min="0" required>
              </div>
              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">ราคาต่อหน่วย (บาท)</label>
                <input type="number" id="unit-price" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" min="0" step="0.01" required>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">ยอดขาย (บาท)</label>
                <input type="number" id="sales-amount" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" min="0" step="0.01" required>
              </div>
              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2">ค่าใช้จ่าย (บาท)</label>
                <input type="number" id="cost" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500" min="0" step="0.01" required>
              </div>
            </div>

            <button type="submit" id="form-submit-btn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white p-3 rounded-md font-medium hover:from-purple-700 hover:to-purple-800 transition">
                            + เพิ่มข้อมูล
                        </button>

            <button type="button" id="form-cancel-btn" onclick="cancelEdit()" class="w-full bg-gray-200 text-gray-700 p-3 rounded-md font-medium mt-2 hover:bg-gray-300 transition hidden">
                            ยกเลิก
                        </button>
          </form>
        </div>

        <!-- ตารางข้อมูล -->
        <div class="bg-white rounded-lg shadow-md p-6 col-span-2">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold">รายการยอดชำระ</h2>
            <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition flex items-center">
                            <i class="fas fa-trash-alt mr-2"></i> ล้างข้อมูล
                        </button>
          </div>

          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="py-3 px-4">แพลตฟอร์ม</th>
                  <th class="py-3 px-4">ลิ้งก์</th>
                  <th class="py-3 px-4">จำนวน</th>
                  <th class="py-3 px-4">ยอดขาย</th>
                  <th class="py-3 px-4">ค่าใช้จ่าย</th>
                  <th class="py-3 px-4">อัตราส่วนค่าใช้จ่าย</th>
                  <th class="py-3 px-4">ROI</th>
                  <th class="py-3 px-4">จัดการ</th>
                </tr>
              </thead>
              <tbody id="data-table-body">
                <!-- ข้อมูลจะถูกโหลดโดย JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- สรุปผลการปฏิบัติงาน -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
        <div class="bg-blue-50 rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-lg font-bold mb-2">Facebook</h2>
              <div class="text-gray-700 text-sm mb-1">ยอดชำระ: <span id="fb-sales">฿0</span></div>
              <div class="text-gray-700 text-sm">ค่าใช้จ่าย: <span id="fb-cost">฿0</span></div>
            </div>
            <div class="bg-blue-500 text-white p-3 rounded-md" id="fb-roi">ROI: 0%</div>
          </div>
        </div>
        <div class="bg-pink-50 rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-lg font-bold mb-2">TikTok</h2>
              <div class="text-gray-700 text-sm mb-1">ยอดชำระ: <span id="tt-sales">฿0</span></div>
              <div class="text-gray-700 text-sm">ค่าใช้จ่าย: <span id="tt-cost">฿0</span></div>
            </div>
            <div class="bg-pink-500 text-white p-3 rounded-md" id="tt-roi">ROI: 0%</div>
          </div>
        </div>
        <div class="bg-yellow-50 rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center">
            <div>
              <h2 class="text-lg font-bold mb-2">Shopee</h2>
              <div class="text-gray-700 text-sm mb-1">ยอดชำระ: <span id="sh-sales">฿0</span></div>
              <div class="text-gray-700 text-sm">ค่าใช้จ่าย: <span id="sh-cost">฿0</span></div>
            </div>
            <div class="bg-yellow-500 text-white p-3 rounded-md" id="sh-roi">ROI: 0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- รายงาน Facebook -->
    <div id="facebook-report" class="report-page">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-blue-600 mb-6 flex items-center">
          <i class="fab fa-facebook mr-2"></i> รายงาน Facebook
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-blue-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">สถิติโดยรวม</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span>ยอดชำระทั้งหมด:</span>
                <span class="font-bold" id="fb-report-sales">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ค่าใช้จ่ายทั้งหมด:</span>
                <span class="font-bold" id="fb-report-cost">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ROI:</span>
                <span class="font-bold text-green-600" id="fb-report-roi">0%</span>
              </div>
              <div class="flex justify-between">
                <span>จำนวนแคมเปญ:</span>
                <span class="font-bold" id="fb-report-campaigns">0</span>
              </div>
            </div>
          </div>

          <div class="bg-blue-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">แคมเปญที่ประสบความสำเร็จ</h3>
            <div class="space-y-3" id="fb-top-campaigns">
              <div class="p-3 bg-white rounded-md">
                <div class="font-medium mb-1">ไม่มีข้อมูล</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-bold text-lg mb-4">กราฟแสดงผลลัพธ์</h3>
          <div class="bg-blue-100 rounded-lg p-8 flex items-center justify-center">
            <div class="text-center">
              <i class="fas fa-chart-line text-blue-500 text-6xl mb-2"></i>
              <p class="text-gray-600">กราฟแสดงยอดขายและ ROI ของ Facebook</p>
            </div>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="font-bold text-lg mb-4">ข้อมูลแคมเปญทั้งหมด</h3>
          <div class="overflow-x-auto">
            <table class="data-table w-full">
              <thead>
                <tr class="bg-blue-50">
                  <th class="py-3 px-4">ชื่อแคมเปญ</th>
                  <th class="py-3 px-4">ยอดขาย</th>
                  <th class="py-3 px-4">ค่าใช้จ่าย</th>
                  <th class="py-3 px-4">ROI</th>
                  <th class="py-3 px-4">วันที่เริ่ม</th>
                  <th class="py-3 px-4">วันที่สิ้นสุด</th>
                </tr>
              </thead>
              <tbody id="fb-campaigns-table">
                <tr>
                  <td colspan="6" class="text-center py-4">ไม่มีข้อมูล</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- รายงาน TikTok -->
    <div id="tiktok-report" class="report-page">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
          <i class="fab fa-tiktok mr-2 text-black"></i> รายงาน TikTok
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-pink-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">สถิติโดยรวม</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span>ยอดชำระทั้งหมด:</span>
                <span class="font-bold" id="tt-report-sales">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ค่าใช้จ่ายทั้งหมด:</span>
                <span class="font-bold" id="tt-report-cost">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ROI:</span>
                <span class="font-bold text-green-600" id="tt-report-roi">0%</span>
              </div>
              <div class="flex justify-between">
                <span>จำนวนวิดีโอ:</span>
                <span class="font-bold" id="tt-report-videos">0</span>
              </div>
            </div>
          </div>

          <div class="bg-pink-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">วิดีโอที่ประสบความสำเร็จ</h3>
            <div class="space-y-3" id="tt-top-videos">
              <div class="p-3 bg-white rounded-md">
                <div class="font-medium mb-1">ไม่มีข้อมูล</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-bold text-lg mb-4">วิดีโอที่มียอดวิวสูงสุด</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="tt-video-grid">
            <div class="bg-gray-100 rounded-lg p-4 text-center">
              <div class="bg-black h-32 flex items-center justify-center text-white mb-3 rounded">
                <i class="fab fa-tiktok text-4xl"></i>
              </div>
              <p class="font-medium">ไม่มีข้อมูล</p>
            </div>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="font-bold text-lg mb-4">ข้อมูลวิดีโอทั้งหมด</h3>
          <div class="overflow-x-auto">
            <table class="data-table w-full">
              <thead>
                <tr class="bg-pink-50">
                  <th class="py-3 px-4">ชื่อวิดีโอ</th>
                  <th class="py-3 px-4">ยอดวิว</th>
                  <th class="py-3 px-4">ยอดขาย</th>
                  <th class="py-3 px-4">ค่าใช้จ่าย</th>
                  <th class="py-3 px-4">ROI</th>
                  <th class="py-3 px-4">วันที่โพสต์</th>
                </tr>
              </thead>
              <tbody id="tt-videos-table">
                <tr>
                  <td colspan="6" class="text-center py-4">ไม่มีข้อมูล</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- รายงาน Shopee -->
    <div id="shopee-report" class="report-page">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-orange-600 mb-6 flex items-center">
          <i class="fas fa-shopping-bag mr-2"></i> รายงาน Shopee
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-yellow-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">สถิติโดยรวม</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span>ยอดชำระทั้งหมด:</span>
                <span class="font-bold" id="sh-report-sales">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ค่าใช้จ่ายทั้งหมด:</span>
                <span class="font-bold" id="sh-report-cost">฿0</span>
              </div>
              <div class="flex justify-between">
                <span>ROI:</span>
                <span class="font-bold text-green-600" id="sh-report-roi">0%</span>
              </div>
              <div class="flex justify-between">
                <span>จำนวนสินค้า:</span>
                <span class="font-bold" id="sh-report-products">0</span>
              </div>
            </div>
          </div>

          <div class="bg-yellow-50 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">สินค้ายอดนิยม</h3>
            <div class="space-y-3" id="sh-top-products">
              <div class="p-3 bg-white rounded-md">
                <div class="font-medium mb-1">ไม่มีข้อมูล</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-bold text-lg mb-4">กราฟยอดขายตามวัน</h3>
          <div class="bg-yellow-100 rounded-lg p-8 flex items-center justify-center">
            <div class="text-center">
              <i class="fas fa-chart-bar text-yellow-600 text-6xl mb-2"></i>
              <p class="text-gray-600">กราฟแสดงยอดขายตามวันของ Shopee</p>
            </div>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="font-bold text-lg mb-4">ข้อมูลสินค้าทั้งหมด</h3>
          <div class="overflow-x-auto">
            <table class="data-table w-full">
              <thead>
                <tr class="bg-yellow-50">
                  <th class="py-3 px-4">ชื่อสินค้า</th>
                  <th class="py-3 px-4">ยอดขาย</th>
                  <th class="py-3 px-4">ราคา</th>
                  <th class="py-3 px-4">จำนวน</th>
                  <th class="py-3 px-4">เรตติ้ง</th>
                  <th class="py-3 px-4">ค่าใช้จ่าย</th>
                  <th class="py-3 px-4">ROI</th>
                </tr>
              </thead>
              <tbody id="sh-products-table">
                <tr>
                  <td colspan="7" class="text-center py-4">ไม่มีข้อมูล</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // โหลดข้อมูลเมื่อหน้าเว็บโหลด
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateSummaryCards();
        });

        // ฟังก์ชันสำหรับสลับหน้า
        function showPage(pageId) {
            // ซ่อนทุกหน้า
            document.querySelectorAll('.report-page').forEach(page => {
                page.classList.remove('active');
                page.classList.add('hidden');
            });

            // แสดงหน้าที่เลือก
            document.getElementById(pageId).classList.add('active');
            document.getElementById(pageId).classList.remove('hidden');

            // อัปเดตสถานะปุ่มเมนู
            document.querySelectorAll('.menu-button').forEach(button => {
                button.classList.remove('bg-purple-600', 'text-white');
                button.classList.add('bg-gray-200', 'text-gray-700');
            });

            event.currentTarget.classList.remove('bg-gray-200', 'text-gray-700');
            event.currentTarget.classList.add('bg-purple-600', 'text-white');

            // โหลดข้อมูลสำหรับหน้าที่เลือก
            if (pageId === 'dashboard') {
                loadData();
                updateSummaryCards();
            } else if (pageId === 'facebook-report') {
                loadFacebookReport();
            } else if (pageId === 'tiktok-report') {
                loadTikTokReport();
            } else if (pageId === 'shopee-report') {
                loadShopeeReport();
            }
        }

      // ฟังก์ชันสำหรับโหลดข้อมูล (แก้ไข)
      function loadData() {
        Swal.fire({
          title: 'กำลังโหลดข้อมูล...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          },
          showConfirmButton: false
        });

        google.script.run
          .withSuccessHandler(function(response) {
            Swal.close();

            console.log("Data received:", response);

            if (Array.isArray(response)) {
              if (response.length > 0) {
                renderDataTable(response);
                updateSummaryCards(response);
              } else {
                renderDataTable([]);
                Swal.fire({
                  icon: 'info',
                  title: 'ไม่พบข้อมูล',
                  text: 'ยังไม่มีข้อมูลในระบบ กรุณาเพิ่มข้อมูลใหม่',
                  timer: 2000,
                  showConfirmButton: false
                });
              }
            } else if (response && response.success === false) {
              Swal.fire({
                icon: 'error',
                title: 'เกิดข้อผิดพลาด!',
                text: response.error + (response.details ? ': ' + response.details : ''),
              });
            }
          })
          .withFailureHandler(function(error) {
            Swal.close();
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
            });
          })
          .getAllData();
      }

      // ฟังก์ชันสำหรับแสดงข้อมูลในตาราง (แก้ไข)
      function renderDataTable(data) {
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = '';

        if (!data || data.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="8" class="text-center py-6 text-gray-500">
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-database text-3xl mb-2 text-gray-300"></i>
                <p class="text-sm">ไม่พบข้อมูลในระบบ</p>
                <p class="text-xs mt-1">กรุณาเพิ่มข้อมูลใหม่โดยใช้ฟอร์มด้านซ้าย</p>
              </div>
            </td>
          `;
          tableBody.appendChild(row);
          return;
        }

        // จัดเรียงข้อมูลจากใหม่ไปเก่า
        data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        data.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 transition-colors duration-150';

          const date = new Date(item.timestamp);
          const formattedDate = date.toLocaleString('th-TH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          let platformClass = '';
          if (item.platform === 'Facebook') {
            platformClass = 'text-blue-600';
          } else if (item.platform === 'TikTok') {
            platformClass = 'text-black dark:text-white';
          } else if (item.platform === 'Shopee') {
            platformClass = 'text-orange-500';
          }

          row.innerHTML = `
            <td class="py-3 px-4 border-b border-gray-100 ${platformClass} font-medium">
              ${item.platform}
            </td>
            <td class="py-3 px-4 border-b border-gray-100">
              <div class="truncate max-w-xs" title="${item.linkName}">${item.linkName}</div>
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-right">
              ${parseInt(item.quantity).toLocaleString()}
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-right font-medium text-green-600">
              ฿${parseFloat(item.salesAmount).toLocaleString()}
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-right">
              ฿${parseFloat(item.cost).toLocaleString()}
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-center">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${getRatioColor(item.costToSalesRatio)}">
                ${item.costToSalesRatio}
              </span>
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-center">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${getROIColor(item.roi)}">
                ${item.roi}
              </span>
            </td>
            <td class="py-3 px-4 border-b border-gray-100 text-center">
              <div class="flex justify-center space-x-2">
                <button onclick="editRow(${item.id})" class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-50 transition-colors">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteRow(${item.id})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50 transition-colors">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          `;

          tableBody.appendChild(row);
        });
      }


      // ฟังก์ชันสำหรับกำหนดสีตามอัตราส่วนค่าใช้จ่าย
      function getRatioColor(ratio) {
        if (!ratio || ratio === "0%") return "bg-gray-200 text-gray-600";

        const value = parseFloat(ratio);
        if (value < 20) return "bg-green-100 text-green-800";
        if (value < 50) return "bg-yellow-100 text-yellow-800";
        return "bg-red-100 text-red-800";
      }

      // ฟังก์ชันสำหรับกำหนดสีตาม ROI
      function getROIColor(roi) {
        if (!roi || roi === "N/A") return "bg-gray-200 text-gray-600";

        const value = parseFloat(roi);
        if (value > 100) return "bg-green-100 text-green-800";
        if (value > 0) return "bg-blue-100 text-blue-800";
        if (value > -50) return "bg-yellow-100 text-yellow-800";
        return "bg-red-100 text-red-800";
      }

      // ฟังก์ชันสำหรับบันทึกข้อมูล (แก้ไข)
      function saveForm() {
        const form = document.getElementById('sales-form');
        const editRowIndex = document.getElementById('edit-row-index').value;

        const formData = {
          platform: document.getElementById('platform').value,
          linkName: document.getElementById('link-name').value,
          quantity: document.getElementById('quantity').value,
          unitPrice: document.getElementById('unit-price').value,
          salesAmount: document.getElementById('sales-amount').value,
          cost: document.getElementById('cost').value
        };

        if (!validateForm(formData)) {
          return;
        }

        Swal.fire({
          title: editRowIndex === '-1' ? 'กำลังบันทึกข้อมูล...' : 'กำลังอัปเดตข้อมูล...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const successHandler = function(response) {
          Swal.close();

          // ตรวจสอบว่าข้อมูลที่ได้รับมามีรูปแบบถูกต้อง
          console.log("Response from server:", response);

          if (Array.isArray(response)) {
            // ถ้าเป็น array แสดงว่าบันทึกสำเร็จ
            Swal.fire({
              icon: 'success',
              title: 'สำเร็จ!',
              text: editRowIndex === '-1' ? 'บันทึกข้อมูลสำเร็จ!' : 'อัปเดตข้อมูลสำเร็จ!',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              renderDataTable(response);
              updateSummaryCards(response);

              if (editRowIndex === '-1') {
                form.reset();
              } else {
                cancelEdit();
              }
            });
          } else if (response && response.success === false) {
            // ถ้าเป็น object ที่มี success: false แสดงว่ามีข้อผิดพลาด
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: response.error + (response.details ? ': ' + response.details : ''),
            });
          } else {
            // กรณีอื่นๆ ที่ไม่รู้จัก
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: 'ได้รับข้อมูลที่ไม่ถูกต้องจากเซิร์ฟเวอร์',
            });
          }
        };

        const failureHandler = function(error) {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด!',
            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
          });
        };

        if (editRowIndex === '-1') {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .saveData(formData);
        } else {
          formData.rowIndex = parseInt(editRowIndex);
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .updateData(formData);
        }
      }



        // ฟังก์ชันสำหรับตรวจสอบความถูกต้องของฟอร์ม
        function validateForm(data) {
            if (!data.platform) {
                showError('กรุณาเลือกแพลตฟอร์ม');
                return false;
            }

            if (!data.linkName || data.linkName.trim() === '') {
                showError('กรุณาระบุชื่อลิงก์');
                return false;
            }

            if (isNaN(data.quantity) || parseInt(data.quantity) <= 0) {
                showError('กรุณาระบุจำนวนที่ถูกต้อง');
                return false;
            }

            if (isNaN(data.unitPrice) || parseFloat(data.unitPrice) <= 0) {
                showError('กรุณาระบุราคาต่อหน่วยที่ถูกต้อง');
                return false;
            }

            if (isNaN(data.salesAmount) || parseFloat(data.salesAmount) <= 0) {
                showError('กรุณาระบุยอดขายที่ถูกต้อง');
                return false;
            }

            if (isNaN(data.cost) || parseFloat(data.cost) < 0) {
                showError('กรุณาระบุค่าใช้จ่ายที่ถูกต้อง');
                return false;
            }

            return true;
        }

        /// ฟังก์ชันสำหรับแก้ไขแถว (แก้ไข)
function editRow(rowId) {
  Swal.fire({
    title: 'กำลังโหลดข้อมูล...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    },
    showConfirmButton: false
  });

  google.script.run
    .withSuccessHandler(function(response) {
      Swal.close();

      if (Array.isArray(response) && response.length > 0) {
        const item = response.find(item => item.id === rowId);
        if (item) {
          document.getElementById('platform').value = item.platform;
          document.getElementById('link-name').value = item.linkName;
          document.getElementById('quantity').value = item.quantity;
          document.getElementById('unit-price').value = item.unitPrice;
          document.getElementById('sales-amount').value = item.salesAmount;
          document.getElementById('cost').value = item.cost;

          document.getElementById('edit-row-index').value = rowId;
          document.getElementById('form-title').textContent = 'แก้ไขข้อมูล';
          document.getElementById('sales-form').classList.add('edit-mode');
          document.getElementById('form-submit-btn').textContent = 'อัปเดตข้อมูล';
          document.getElementById('form-cancel-btn').classList.remove('hidden');

          document.getElementById('sales-form').scrollIntoView({ behavior: 'smooth' });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'ไม่พบข้อมูล',
            text: 'ไม่สามารถหาข้อมูลที่ต้องการแก้ไขได้',
          });
        }
      } else {
        Swal.fire({
          icon: 'error',
          title: 'เกิดข้อผิดพลาด',
          text: 'ไม่สามารถโหลดข้อมูลได้',
        });
      }
    })
    .withFailureHandler(function(error) {
      Swal.close();
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด!',
        text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
      });
    })
    .getAllData();
}


// ฟังก์ชันสำหรับลบแถว (แก้ไข)
function deleteRow(rowId) {
  Swal.fire({
    title: 'คุณแน่ใจหรือไม่?',
    text: "คุณจะไม่สามารถย้อนกลับการกระทำนี้ได้!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'ใช่, ลบเลย!',
    cancelButtonText: 'ยกเลิก'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'กำลังลบข้อมูล...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run
        .withSuccessHandler(function(response) {
          Swal.close();

          if (Array.isArray(response)) {
            Swal.fire({
              icon: 'success',
              title: 'ลบข้อมูลสำเร็จ!',
              timer: 1500,
              showConfirmButton: false
            });
            renderDataTable(response);
            updateSummaryCards(response);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: response.error || 'ไม่สามารถลบข้อมูลได้',
            });
          }
        })
        .withFailureHandler(function(error) {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด!',
            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
          });
        })
        .deleteRow({rowIndex: rowId});
    }
  });
}
        // ฟังก์ชันสำหรับยกเลิกการแก้ไข
        function cancelEdit() {
            document.getElementById('sales-form').reset();
            document.getElementById('edit-row-index').value = '-1';
            document.getElementById('form-title').textContent = '+ เพิ่มข้อมูลยอดชำระ';
            document.getElementById('sales-form').classList.remove('edit-mode');
            document.getElementById('form-submit-btn').textContent = '+ เพิ่มข้อมูล';
            document.getElementById('form-cancel-btn').classList.add('hidden');
        }

        // ฟังก์ชันสำหรับล้างข้อมูลทั้งหมด

function clearAllData() {
  Swal.fire({
    title: 'คุณแน่ใจหรือไม่?',
    text: "คุณจะลบข้อมูลทั้งหมดและไม่สามารถย้อนกลับได้!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'ใช่, ลบทั้งหมด!',
    cancelButtonText: 'ยกเลิก'
  }).then((result) => {
    if (result.isConfirmed) {
      Swal.fire({
        title: 'กำลังลบข้อมูลทั้งหมด...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      google.script.run
        .withSuccessHandler(function(response) {
          Swal.close();
          if (response.success) {
            Swal.fire({
              icon: 'success',
              title: 'ลบข้อมูลทั้งหมดสำเร็จ!',
              timer: 1500,
              showConfirmButton: false
            });
            loadData();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'เกิดข้อผิดพลาด!',
              text: response.error + (response.details ? ': ' + response.details : ''),
            });
          }
        })
        .withFailureHandler(function(error) {
          Swal.close();
          Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด!',
            text: 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้: ' + error.message,
          });
        })
        .clearAllData();
    }
  });
}

       function updateSummaryCards(data) {
          if (!data || data.length === 0) {
            // ถ้าไม่มีข้อมูล ให้รีเซ็ตค่าเป็น 0
            document.getElementById('totalSales').textContent = '฿0';
            document.getElementById('totalInstall').textContent = '฿0';
            document.getElementById('totalAmount').textContent = '฿0';
            document.getElementById('totalCost').textContent = '฿0';

            document.getElementById('fb-sales').textContent = '฿0';
            document.getElementById('fb-cost').textContent = '฿0';
            document.getElementById('fb-roi').textContent = 'ROI: N/A';

            document.getElementById('tt-sales').textContent = '฿0';
            document.getElementById('tt-cost').textContent = '฿0';
            document.getElementById('tt-roi').textContent = 'ROI: N/A';

            document.getElementById('sh-sales').textContent = '฿0';
            document.getElementById('sh-cost').textContent = '฿0';
            document.getElementById('sh-roi').textContent = 'ROI: N/A';

            return;
          }

          let totalSales = 0;
          let totalCost = 0;
          let fbSales = 0;
          let fbCost = 0;
          let ttSales = 0;
          let ttCost = 0;
          let shSales = 0;
          let shCost = 0;

          data.forEach(item => {
            const sales = parseFloat(item.salesAmount) || 0;
            const cost = parseFloat(item.cost) || 0;

            totalSales += sales;
            totalCost += cost;

            if (item.platform === 'Facebook') {
              fbSales += sales;
              fbCost += cost;
            } else if (item.platform === 'TikTok') {
              ttSales += sales;
              ttCost += cost;
            } else if (item.platform === 'Shopee') {
              shSales += sales;
              shCost += cost;
            }
          });

          document.getElementById('totalSales').textContent = '฿' + totalSales.toLocaleString();
          document.getElementById('totalInstall').textContent = '฿' + (totalSales * 0.05).toLocaleString();
          document.getElementById('totalAmount').textContent = '฿' + (totalSales - (totalSales * 0.05)).toLocaleString();
          document.getElementById('totalCost').textContent = '฿' + totalCost.toLocaleString();

          document.getElementById('fb-sales').textContent = '฿' + fbSales.toLocaleString();
          document.getElementById('fb-cost').textContent = '฿' + fbCost.toLocaleString();
          document.getElementById('fb-roi').textContent = fbCost > 0
            ? 'ROI: ' + (((fbSales - fbCost) / fbCost) * 100).toFixed(2) + '%'
            : 'ROI: N/A';

          document.getElementById('tt-sales').textContent = '฿' + ttSales.toLocaleString();
          document.getElementById('tt-cost').textContent = '฿' + ttCost.toLocaleString();
          document.getElementById('tt-roi').textContent = ttCost > 0
            ? 'ROI: ' + (((ttSales - ttCost) / ttCost) * 100).toFixed(2) + '%'
            : 'ROI: N/A';

          document.getElementById('sh-sales').textContent = '฿' + shSales.toLocaleString();
          document.getElementById('sh-cost').textContent = '฿' + shCost.toLocaleString();
          document.getElementById('sh-roi').textContent = shCost > 0
            ? 'ROI: ' + (((shSales - shCost) / shCost) * 100).toFixed(2) + '%'
            : 'ROI: N/A';
        }

        // ฟังก์ชันสำหรับโหลดรายงาน Facebook
        function loadFacebookReport() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const fbData = response.data.filter(item => item.platform === 'Facebook');

                        // อัปเดตสถิติ
                        let totalSales = 0;
                        let totalCost = 0;
                        const campaigns = {};

                        fbData.forEach(item => {
                            totalSales += parseFloat(item.salesAmount) || 0;
                            totalCost += parseFloat(item.cost) || 0;

                            if (!campaigns[item.linkName]) {
                                campaigns[item.linkName] = {
                                    sales: 0,
                                    cost: 0,
                                    count: 0
                                };
                            }
                            campaigns[item.linkName].sales += parseFloat(item.salesAmount) || 0;
                            campaigns[item.linkName].cost += parseFloat(item.cost) || 0;
                            campaigns[item.linkName].count++;
                        });

                        // แสดงสถิติ
                        document.getElementById('fb-report-sales').textContent = '฿' + totalSales.toLocaleString();
                        document.getElementById('fb-report-cost').textContent = '฿' + totalCost.toLocaleString();
                        document.getElementById('fb-report-roi').textContent =
                            totalCost > 0 ? (((totalSales - totalCost) / totalCost) * 100).toFixed(2) + '%' : 'N/A';
                        document.getElementById('fb-report-campaigns').textContent = Object.keys(campaigns).length;

                        // แสดงแคมเปญยอดนิยม
                        const topCampaigns = Object.entries(campaigns)
                            .sort((a, b) => b[1].sales - a[1].sales)
                            .slice(0, 3);

                        const topCampaignsContainer = document.getElementById('fb-top-campaigns');
                        topCampaignsContainer.innerHTML = '';

                        topCampaigns.forEach(([name, data]) => {
                            const div = document.createElement('div');
                            div.className = 'p-3 bg-white rounded-md mb-2';
                            div.innerHTML = `
                                <div class="font-medium mb-1">${name}</div>
                                <div class="text-sm text-gray-600">ยอดขาย: ฿${data.sales.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">ค่าใช้จ่าย: ฿${data.cost.toLocaleString()}</div>
                            `;
                            topCampaignsContainer.appendChild(div);
                        });

                        // แสดงตารางแคมเปญ
                        const campaignsTable = document.getElementById('fb-campaigns-table');
                        campaignsTable.innerHTML = '';

                        if (fbData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="6" class="text-center py-4">ไม่มีข้อมูล</td>`;
                            campaignsTable.appendChild(row);
                        } else {
                            fbData.forEach(item => {
                                const row = document.createElement('tr');
                                const date = new Date(item.timestamp);
                                const formattedDate = date.toLocaleDateString('th-TH');

                                row.innerHTML = `
                                    <td class="py-3 px-4">${item.linkName}</td>
                                    <td class="py-3 px-4">฿${parseFloat(item.salesAmount).toLocaleString()}</td>
                                    <td class="py-3 px-4">฿${parseFloat(item.cost).toLocaleString()}</td>
                                    <td class="py-3 px-4">${item.roi}</td>
                                    <td class="py-3 px-4">${formattedDate}</td>
                                    <td class="py-3 px-4">${formattedDate}</td>
                                `;
                                campaignsTable.appendChild(row);
                            });
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    showError('เกิดข้อผิดพลาดในการโหลดรายงาน Facebook: ' + error.message);
                })
                .getAllData();
        }

        // ฟังก์ชันสำหรับโหลดรายงาน TikTok
        function loadTikTokReport() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const ttData = response.data.filter(item => item.platform === 'TikTok');

                        // อัปเดตสถิติ
                        let totalSales = 0;
                        let totalCost = 0;
                        const videos = {};

                        ttData.forEach(item => {
                            totalSales += parseFloat(item.salesAmount) || 0;
                            totalCost += parseFloat(item.cost) || 0;

                            if (!videos[item.linkName]) {
                                videos[item.linkName] = {
                                    sales: 0,
                                    cost: 0,
                                    count: 0
                                };
                            }
                            videos[item.linkName].sales += parseFloat(item.salesAmount) || 0;
                            videos[item.linkName].cost += parseFloat(item.cost) || 0;
                            videos[item.linkName].count++;
                        });

                        // แสดงสถิติ
                        document.getElementById('tt-report-sales').textContent = '฿' + totalSales.toLocaleString();
                        document.getElementById('tt-report-cost').textContent = '฿' + totalCost.toLocaleString();
                        document.getElementById('tt-report-roi').textContent =
                            totalCost > 0 ? (((totalSales - totalCost) / totalCost) * 100).toFixed(2) + '%' : 'N/A';
                        document.getElementById('tt-report-videos').textContent = Object.keys(videos).length;

                        // แสดงวิดีโอยอดนิยม
                        const topVideos = Object.entries(videos)
                            .sort((a, b) => b[1].sales - a[1].sales)
                            .slice(0, 3);

                        const topVideosContainer = document.getElementById('tt-top-videos');
                        topVideosContainer.innerHTML = '';

                        topVideos.forEach(([name, data]) => {
                            const div = document.createElement('div');
                            div.className = 'p-3 bg-white rounded-md mb-2';
                            div.innerHTML = `
                                <div class="font-medium mb-1">${name}</div>
                                <div class="text-sm text-gray-600">ยอดขาย: ฿${data.sales.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">ค่าใช้จ่าย: ฿${data.cost.toLocaleString()}</div>
                            `;
                            topVideosContainer.appendChild(div);
                        });

                        // แสดงกริดวิดีโอ
                        const videoGrid = document.getElementById('tt-video-grid');
                        videoGrid.innerHTML = '';

                        if (ttData.length === 0) {
                            const div = document.createElement('div');
                            div.className = 'bg-gray-100 rounded-lg p-4 text-center col-span-3';
                            div.textContent = 'ไม่มีข้อมูล';
                            videoGrid.appendChild(div);
                        } else {
                            ttData.slice(0, 3).forEach(item => {
                                const div = document.createElement('div');
                                div.className = 'bg-gray-100 rounded-lg overflow-hidden';
                                div.innerHTML = `
                                    <div class="bg-black h-32 flex items-center justify-center text-white mb-3 rounded-t-lg">
                                        <i class="fab fa-tiktok text-4xl"></i>
                                    </div>
                                    <div class="p-3">
                                        <p class="font-medium truncate">${item.linkName}</p>
                                        <p class="text-sm text-gray-600 mt-1">ยอดขาย: ฿${parseFloat(item.salesAmount).toLocaleString()}</p>
                                    </div>
                                `;
                                videoGrid.appendChild(div);
                            });
                        }

                        // แสดงตารางวิดีโอ
                        const videosTable = document.getElementById('tt-videos-table');
                        videosTable.innerHTML = '';

                        if (ttData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="6" class="text-center py-4">ไม่มีข้อมูล</td>`;
                            videosTable.appendChild(row);
                        } else {
                            ttData.forEach(item => {
                                const row = document.createElement('tr');
                                const date = new Date(item.timestamp);
                                const formattedDate = date.toLocaleDateString('th-TH');

                                row.innerHTML = `
                                    <td class="py-3 px-4">${item.linkName}</td>
                                    <td class="py-3 px-4">${Math.floor(Math.random() * 1000000) + 500000}</td> <!-- สมมติยอดวิว -->
                                    <td class="py-3 px-4">฿${parseFloat(item.salesAmount).toLocaleString()}</td>
                                    <td class="py-3 px-4">฿${parseFloat(item.cost).toLocaleString()}</td>
                                    <td class="py-3 px-4">${item.roi}</td>
                                    <td class="py-3 px-4">${formattedDate}</td>
                                `;
                                videosTable.appendChild(row);
                            });
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    showError('เกิดข้อผิดพลาดในการโหลดรายงาน TikTok: ' + error.message);
                })
                .getAllData();
        }

        // ฟังก์ชันสำหรับโหลดรายงาน Shopee
        function loadShopeeReport() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const shData = response.data.filter(item => item.platform === 'Shopee');

                        // อัปเดตสถิติ
                        let totalSales = 0;
                        let totalCost = 0;
                        const products = {};

                        shData.forEach(item => {
                            totalSales += parseFloat(item.salesAmount) || 0;
                            totalCost += parseFloat(item.cost) || 0;

                            if (!products[item.linkName]) {
                                products[item.linkName] = {
                                    sales: 0,
                                    cost: 0,
                                    count: 0
                                };
                            }
                            products[item.linkName].sales += parseFloat(item.salesAmount) || 0;
                            products[item.linkName].cost += parseFloat(item.cost) || 0;
                            products[item.linkName].count++;
                        });

                        // แสดงสถิติ
                        document.getElementById('sh-report-sales').textContent = '฿' + totalSales.toLocaleString();
                        document.getElementById('sh-report-cost').textContent = '฿' + totalCost.toLocaleString();
                        document.getElementById('sh-report-roi').textContent =
                            totalCost > 0 ? (((totalSales - totalCost) / totalCost) * 100).toFixed(2) + '%' : 'N/A';
                        document.getElementById('sh-report-products').textContent = Object.keys(products).length;

                        // แสดงสินค้ายอดนิยม
                        const topProducts = Object.entries(products)
                            .sort((a, b) => b[1].sales - a[1].sales)
                            .slice(0, 3);

                        const topProductsContainer = document.getElementById('sh-top-products');
                        topProductsContainer.innerHTML = '';

                        topProducts.forEach(([name, data]) => {
                            const div = document.createElement('div');
                            div.className = 'p-3 bg-white rounded-md mb-2';
                            div.innerHTML = `
                                <div class="font-medium mb-1">${name}</div>
                                <div class="text-sm text-gray-600">ยอดขาย: ฿${data.sales.toLocaleString()}</div>
                                <div class="text-sm text-gray-600">ค่าใช้จ่าย: ฿${data.cost.toLocaleString()}</div>
                            `;
                            topProductsContainer.appendChild(div);
                        });

                        // แสดงตารางสินค้า
                        const productsTable = document.getElementById('sh-products-table');
                        productsTable.innerHTML = '';

                        if (shData.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="7" class="text-center py-4">ไม่มีข้อมูล</td>`;
                            productsTable.appendChild(row);
                        } else {
                            shData.forEach(item => {
                                const row = document.createElement('tr');

                                row.innerHTML = `
                                    <td class="py-3 px-4">${item.linkName}</td>
                                    <td class="py-3 px-4">฿${parseFloat(item.salesAmount).toLocaleString()}</td>
                                    <td class="py-3 px-4">฿${parseFloat(item.unitPrice).toLocaleString()}</td>
                                    <td class="py-3 px-4">${parseInt(item.quantity).toLocaleString()}</td>
                                    <td class="py-3 px-4">${(Math.random() * 1 + 4).toFixed(1)}/5</td> <!-- สมมติเรตติ้ง -->
                                    <td class="py-3 px-4">฿${parseFloat(item.cost).toLocaleString()}</td>
                                    <td class="py-3 px-4">${item.roi}</td>
                                `;
                                productsTable.appendChild(row);
                            });
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    showError('เกิดข้อผิดพลาดในการโหลดรายงาน Shopee: ' + error.message);
                })
                .getAllData();
        }

        // ฟังก์ชันสำหรับแสดงข้อความสำเร็จ
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 z-50 p-4 rounded-md bg-green-100 border border-green-400 text-green-700';
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'transition-opacity');
                setTimeout(() => {
                    alertDiv.remove();
                }, 500);
            }, 3000);
        }

        // ฟังก์ชันสำหรับแสดงข้อความผิดพลาด
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 z-50 p-4 rounded-md bg-red-100 border border-red-400 text-red-700';
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('opacity-0', 'transition-opacity');
                setTimeout(() => {
                    alertDiv.remove();
                }, 500);
            }, 5000);
        }

        // ฟังก์ชันสำหรับคำนวณยอดรวม
        function calculateTotals(data) {
            if (!data) return;

            let totalSales = 0;
            let totalCost = 0;

            data.forEach(item => {
                totalSales += parseFloat(item.salesAmount) || 0;
                totalCost += parseFloat(item.cost) || 0;
            });

            // อัปเดตการ์ดสถิติ
            document.getElementById('totalSales').textContent = '฿' + totalSales.toLocaleString();
            document.getElementById('totalCost').textContent = '฿' + totalCost.toLocaleString();
        }
  </script>
</body>

</html>
